# Process Notes for the Social-Refresh bot


## Prepping for Lambda

We worked to put Ryan Restivo's code into a function that will be called by the AWS system. [More details here](https://docs.aws.amazon.com/lambda/latest/dg/python-programming-model-handler-types.html), but the basic setup is:

```python
def handler_name(event, context): 
    ...
    return some_value
``` 

... where the `event` and `context` come in from whatever triggers the lambda function.

## Uploading to Lambda using Zappa

Most of the Quackbot code base is written in Javascript, and we're using Claudiajs to deploy that code into an AWS Lambda function. But since this is Pythin code, we're going to use [Zappa](https://github.com/Miserlou/Zappa).


### Setting up the virtual environment

Using virtualenv as Zappa requires.

```bash
# installing virtualenv
pip install virtualenv

# move into the project directory
cd quackbot/slack-events-api-bots/social-refresh

# create a virtual environment called venv there
# using the python2.7 version already on my system
virtualenv -p /usr/bin/python2.7 venv

# activate the virtual environment
source venv/bin/activate
```

Also added `venv` to the `.gitignore` so we don't copy the whole environment to github.

### Initializing Zappa

```bash
# zappa needs to go into the virtual environment
pip install zappa
zappa init
```

Walked through a bunch of questions to then create the `zappa_settings.json` file.

Eventually, changed up many of the settings there. Take a peek to see.  

And then tried the deploy function:

## New Approach: AWS SAM

So the whole web-app/flask/zappa thing might work well for web services, but it's looking to be overly complicated for deploying a Python lambda function that will be invoked by another lambda function.

So I'm going to try this:

Building Applications with Dependencies: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-using-build.html

ANd this: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-deploying.html


Here's the Command Line Interface page: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-reference.html#serverless-sam-cli

Which is going to require docker, too: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html

### Install Steps

1. Installed [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/install-macos.html#awscli-install-osx-pip) (which I had already).
1. Downloaded and installed [Docker](https://hub.docker.com/editions/community/docker-ce-desktop-mac) for locally running the functions on my Mac.
1. Installed [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html).
1. Added the SAM CLI to my Python $PATH [this way](https://www.architectryan.com/2012/10/02/add-to-the-path-on-mac-os-x-mountain-lion/).
1. Opened a new Terminal window in same directory so all the paths get loaded
1. Did ```source venv/bin/activate```
1. Made sure all of my dependencies where installed using `pip` while in the venv. ie: ```pip install requests```
1. Made a `requirements.txt` file using `pip freeze > requirements.txt`


OK, now I'm following along with [this guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-reference.html#serverless-sam-cli) to create an inital app to work off of -- making sure to declare the Python 2.7 version (otherwise it built it in Node).

```
sam init --runtime python2.7
```

Did a bunch of fixing of the `template.yaml` file, based on values listed [here](https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md). 

Continuing with the instructions in the README for the sam-app (which was generated by `sam init`):

```
sam build
sam package --output-template-file packaged.yaml --s3-bucket botstudio-lambda-payload-staging
```

And

```
sam deploy --template-file packaged.yaml --stack-name quackbot-social-refresh-stack --capabilities CAPABILITY_IAM
```

Finally got:

```Successfully created/updated stack - quackbot-social-refresh-stack```

